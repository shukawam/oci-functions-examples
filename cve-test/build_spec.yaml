# https://docs.oracle.com/ja-jp/iaas/Content/devops/using/build_specs.htm
# build runner config
version: 0.1
component: build
timeoutInSeconds: 10000
shell: bash
env:
  variables:
    function_name: cve-test
    function_version: 0.0.1
  vaultVariables:
    knowledge_base_id: ocid1.vaultsecret.oc1.ap-tokyo-1.amaaaaaassl65iqaablb7derm2qhtvjqejwssa3pxgcb63vcekl5sahyambq
    compartment_id: ocid1.vaultsecret.oc1.ap-tokyo-1.amaaaaaassl65iqalcczhbq3u4fk7pacecelhjzkbt52y5s7sqih3faphsfq
  exportedVariables:
    - tag

# steps
steps:
  - type: Command
    name: "Prepare variables"
    timeoutInSeconds: 4000
    command: |
      tag=`echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7`
      echo ${knowledge_base_id}
      echo ${compartment_id}
    onFailure:
      - type: Command
        command: |
          echo "Failure successfully handled"
        timeoutInSeconds: 60

  - type: VulnerabilityAudit
    name: "Vulnerability Audit Step"
    configuration:
      buildType: maven
      pomFilePath: ${OCI_PRIMARY_SOURCE_DIR}/cve-test/pom.xml
      maxPermissibleCvssV2Score: 1.0
      maxPermissibleCvssV3Score: 5.0
    knowledgeBaseId: ${knowledge_base_id}
    vulnerabilityAuditCompartmentId: ${compartment_id}
    vulnerabilityAuditName: fdk-java-audit-${tag}

  - type: Command
    name: "Docker image build"
    timeoutInSeconds: 4000
    command: |
      cd cve-test
      mvn test
      fn build --verbose
      docker tag ${function_name}:${function_version} ${function_name}
    onFailure:
      - type: Command
        command: |
          echo "Failure successfully handled"
        timeoutInSeconds: 60

outputArtifacts:
  - name: cve-test
    type: DOCKER_IMAGE
    location: cve-test
