# https://docs.oracle.com/ja-jp/iaas/Content/devops/using/build_specs.htm
# build runner config
version: 0.1
component: build
timeoutInSeconds: 10000
shell: bash
env:
  variables:
    function_name: cve-test
    function_version: 0.0.1
  exportedVariables:
    - tag

# steps
steps:
  - type: VulnerabilityAudit
    name: "Vulnerability Audit Step"
    configuration:
      buildType: maven
      pomFilePath: ${OCI_PRIMARY_SOURCE_DIR}/cve-test/pom.xml
      maxPermissibleCvssV2Score: 10.0
      maxPermissibleCvssV3Score: 10.0
    knowledgeBaseId: ocid1.admknowledgebase.oc1.ap-tokyo-1.amaaaaaassl65iqaxlcyg3cy3fakw4wnrktgjjc4o72ylglzndmjxxro5fea
    vulnerabilityAuditCompartmentId: ocid1.compartment.oc1..aaaaaaaanjtbllhqxcg67dq7em3vto2mvsbc6pbgk4pw6cx37afzk3tngmoa
    vulnerabilityAuditName: sample-audit
  - type: Command
    name: "Docker image build"
    timeoutInSeconds: 4000
    command: |
      cd cve-test
      mvn test
      fn build --verbose
      docker tag ${function_name}:${function_version} ${function_name}
      tag=`echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7`
    onFailure:
      - type: Command
        command: |
          echo "Failure successfully handled"
        timeoutInSeconds: 60

outputArtifacts:
  - name: cve-test
    type: DOCKER_IMAGE
    location: cve-test
